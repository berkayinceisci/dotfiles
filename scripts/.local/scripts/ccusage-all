#!/bin/bash
set -euo pipefail

# Show Claude Code total cost across all machines.
# Reads local data + remote data pushed by ccusage-push.

command -v ccusage >/dev/null || { echo "ccusage not found"; exit 1; }
command -v jq >/dev/null || { echo "jq not found"; exit 1; }

REMOTE_DIR="$HOME/.claude/remote"
FAKE_HOME="/tmp/ccusage-fake-home"
GRAND_TOTAL=0

# Get total cost from a projects dir. Prints "label: $cost".
get_cost() {
    local label="$1"
    local projects_dir="$2"

    if [[ ! -d "$projects_dir" ]] || [[ -z "$(ls -A "$projects_dir" 2>/dev/null)" ]]; then
        return
    fi

    rm -rf "$FAKE_HOME"
    mkdir -p "$FAKE_HOME/.claude"
    ln -s "$projects_dir" "$FAKE_HOME/.claude/projects"

    local cost
    cost=$(HOME="$FAKE_HOME" ccusage monthly --json 2>/dev/null \
        | jq '[.monthly[].totalCost] | add // 0') || return
    printf "%-30s \$%.2f\n" "$label" "$cost"
    GRAND_TOTAL=$(echo "$GRAND_TOTAL + $cost" | bc)
}

# Local usage
get_cost "$(hostname)" "$HOME/.claude/projects"

# Remote machines
if [[ -d "$REMOTE_DIR" ]]; then
    for machine_dir in "$REMOTE_DIR"/*/; do
        [[ -d "$machine_dir" ]] || continue
        get_cost "$(basename "$machine_dir")" "$machine_dir/projects"
    done
fi

rm -rf "$FAKE_HOME"

echo "---"
printf "%-30s \$%.2f\n" "Total" "$GRAND_TOTAL"
