#!/bin/bash
IFACE=$(ip route | awk '/default/ {print $5; exit}')
STATS_FILE="/tmp/i3blocks_net_stats"

wifi_line=$(nmcli -t -f active,ssid,signal dev wifi 2>/dev/null | grep "^yes:")
if [[ -n "$wifi_line" ]]; then
    signal="${wifi_line##*:}"
    ssid="${wifi_line#yes:}"
    ssid="${ssid%:*}"
    ip=$(ip -4 addr show "$IFACE" 2>/dev/null | grep -oP '(?<=inet\s)[0-9.]+' | head -1)

    # Calculate speed
    rx=$(cat "/sys/class/net/$IFACE/statistics/rx_bytes" 2>/dev/null || echo 0)
    tx=$(cat "/sys/class/net/$IFACE/statistics/tx_bytes" 2>/dev/null || echo 0)
    now=$(date +%s)

    rx_rate=0
    tx_rate=0
    if [[ -f "$STATS_FILE" ]]; then
        read -r old_rx old_tx old_time < "$STATS_FILE"
        interval=$((now - old_time))
        if [[ $interval -gt 0 ]]; then
            rx_rate=$(( (rx - old_rx) / interval / 1024 ))
            tx_rate=$(( (tx - old_tx) / interval / 1024 ))
        fi
    fi
    echo "$rx $tx $now" > "$STATS_FILE"
    # Fixed-width speed: left-aligned, 6 chars each
    down=$(printf "%-6s" "${rx_rate}K")
    up=$(printf "%-6s" "${tx_rate}K")
    speed="↓${down} ↑${up}"

    # Ping latency (fixed-width: 6 chars)
    ping_ms=$(ping -c1 -W1 1.1.1.1 2>/dev/null | grep -oP 'time=\K[0-9.]+' || echo "")
    if [[ -n "$ping_ms" ]]; then
        ping_int=${ping_ms%.*}
        ping_str=$(printf "%3dms" "$ping_int")
    else
        ping_str="  --"
    fi

    signal_str=$(printf "%-4s" "${signal}%")
    echo "W: (${signal_str} ${ping_str}) ${ip} ${speed}"
else
    echo "W: down"
    echo ""
    echo "#bf616a"
fi
