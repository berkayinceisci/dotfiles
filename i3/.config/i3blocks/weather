#!/bin/bash
CITY="Blacksburg"
CACHE_FILE="/tmp/i3blocks_weather_cache"

get_emoji() {
    case "${1,,}" in
        *snow*|*blizzard*) echo "â„ï¸" ;;
        *thunder*|*storm*) echo "â›ˆï¸" ;;
        *rain*|*drizzle*|*shower*) echo "ðŸŒ§ï¸" ;;
        *partly*|*partially*) echo "â›…" ;;
        *cloud*|*overcast*) echo "â˜ï¸" ;;
        *sun*|*clear*) echo "â˜€ï¸" ;;
        *fog*|*mist*|*haze*) echo "ðŸŒ«ï¸" ;;
        *wind*) echo "ðŸ’¨" ;;
        *) echo "ðŸŒ¡ï¸" ;;
    esac
}

# Output cached value immediately (non-blocking)
if [[ -f "$CACHE_FILE" ]]; then
    cached=$(cat "$CACHE_FILE")
    emoji=$(get_emoji "$cached")
    echo "$emoji $CITY: $cached"
else
    echo "ðŸŒ¡ï¸ $CITY: ..."
fi

# Update cache in background for next run
(
    weather=$(curl -s "wttr.in/$CITY?format=j1" --max-time 10 | jq -r '.current_condition[0] | "\(.weatherDesc[0].value) \(.temp_F)Â°F"' 2>/dev/null)
    [[ -n "$weather" ]] && echo "$weather" > "$CACHE_FILE"
) &
